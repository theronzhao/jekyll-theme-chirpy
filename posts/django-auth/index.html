<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Django身份认证系统" /><meta property="og:locale" content="en_US" /><meta name="description" content="Django 中的身份认证" /><meta property="og:description" content="Django 中的身份认证" /><link rel="canonical" href="https://justzxy.cn/posts/django-auth/" /><meta property="og:url" content="https://justzxy.cn/posts/django-auth/" /><meta property="og:site_name" content="图样图森破" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-06-08T21:34:55+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Django身份认证系统" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Django 中的身份认证","url":"https://justzxy.cn/posts/django-auth/","headline":"Django身份认证系统","dateModified":"2021-07-19T23:50:50+08:00","datePublished":"2019-06-08T21:34:55+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://justzxy.cn/posts/django-auth/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Django身份认证系统 | 图样图森破</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="图样图森破"><meta name="application-name" content="图样图森破"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">图样图森破</a></div><div class="site-subtitle font-italic">Too Young Too Simple</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Django身份认证系统</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Django身份认证系统</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> tooYoungtooSimple </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 8, 2019, 9:34 PM +0800" prep="on" > Jun 8, 2019 <i class="unloaded">2019-06-08T21:34:55+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jul 19, 2021, 11:50 PM +0800" prefix="Updated " > Jul 19 <i class="unloaded">2021-07-19T23:50:50+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4677 words">25 min</span></div></div><div class="post-content"><h1 id="django-中的身份认证">Django 中的身份认证</h1><p>Django 带有一个用户认证系统。用于处理用户帐户，组，权限和基于 cookie 的用户会话。本文档的这一部分解释了默认实现如何开箱即用，以及如何扩展和定制它以适应您的项目需求。</p><h2 id="概览">概览</h2><p>认证系统由以下部分组成：</p><ul><li>用户(Users)<li>权限(Permissions)：标志指定用户是否可以执行特定任务。<li>组(Groups)：将标签和权限应用于多个用户的通用方式。<li>一个可配置的密码散列系统<li>表单和查看工具，用于登录用户或限制内容<li>可插入的后端系统</ul><p>Django 中的认证系统的目标是非常通用，并且不提供 Web 认证系统中常见的一些功能。第三方软件包已经实施了一些常见问题的解决方案：</p><ul><li>密码强度检查<li>限制登录尝试<li>针对第三方的身份认证（例如，OAuth）</ul><h2 id="安装">安装</h2><p>身份认证 ( Authentication ) 在 <code class="language-plaintext highlighter-rouge">django.contrib.auth</code> 中作为 Django contrib 模块捆绑在一起。默认情况下，所需的配置已包含在由 <code class="language-plaintext highlighter-rouge">django-admin startproject</code> 生成的 <code class="language-plaintext highlighter-rouge">settings.py</code> 中，这些配置由 <code class="language-plaintext highlighter-rouge">INSTALLED_APPS</code> setting 中列出的两个项目组成：</p><ol><li><code class="language-plaintext highlighter-rouge">'django.contrib.auth'</code> 包含身份认证 ( authentication ) 框架的核心，以及它的默认模型。<li><code class="language-plaintext highlighter-rouge">'django.contrib.contenttypes'</code> 是 Django 内容类型系统，它允许权限与您创建的模型相关联。</ol><p>以及 <code class="language-plaintext highlighter-rouge">MIDDLEWARE</code> setting 中的这些项目：</p><ol><li><code class="language-plaintext highlighter-rouge">SessionMiddleware</code> 管理跨请求的会话。<li><code class="language-plaintext highlighter-rouge">AuthenticationMiddleware</code> 使用会话将用户与请求相关联。</ol><p>使用这些设置后，运行命令 <code class="language-plaintext highlighter-rouge">manage.py migrate</code> 将为 auth 相关模型创建必要的数据库表，并为安装的应用程序中定义的模型创建权限。</p><h1 id="使用-django-身份认证系统">使用 Django 身份认证系统</h1><p>本文档解释了 Django 认证系统在其默认配置中的用法。这种配置已经发展到满足最常见的项目需求，处理合理范围广泛的任务，并且仔细实现了密码和权限。对于认证需求与默认不同的项目，Django 支持广泛的扩展和定制认证。</p><p>Django 中的认证系统认证和授权在一起，因为这些功能有些耦合。</p><h2 id="user-对象">User 对象</h2><p><code class="language-plaintext highlighter-rouge">User</code> 对象是认证系统的核心。他们通常代表与您的网站进行互动的人，并用于实现限制访问，注册用户信息，将内容与创作者相关联等。在 Django 的身份验证框架中只存在一类用户，即 <code class="language-plaintext highlighter-rouge">'superusers'</code> 或 admin <code class="language-plaintext highlighter-rouge">'staff'</code> 用户是具有特殊属性集的用户对象，而不是不同类的用户对象。</p><p>默认用户的主要属性是：</p><ul><li><code class="language-plaintext highlighter-rouge">username</code><li><code class="language-plaintext highlighter-rouge">password</code><li><code class="language-plaintext highlighter-rouge">email</code><li><code class="language-plaintext highlighter-rouge">first_name</code><li><code class="language-plaintext highlighter-rouge">last_name</code></ul><h3 id="创建用户">创建用户</h3><p>创建用户最直接的方法是使用包含的 <code class="language-plaintext highlighter-rouge">create_user()</code> 辅助函数：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; user = User.objects.create_user('john', 'lennon@thebeatles.com', 'johnpassword')

# At this point, user is a User object that has already been saved
# to the database. You can continue to change its attributes
# if you want to change other fields.
&gt;&gt;&gt; user.last_name = 'Lennon'
&gt;&gt;&gt; user.save()
</pre></table></code></div></div><h3 id="创建超级用户">创建超级用户</h3><p>使用 <code class="language-plaintext highlighter-rouge">createsuperuser</code> 命令创建超级用户：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ python manage.py createsuperuser --username=joe --email=vip@django.cn
</pre></table></code></div></div><p>系统会提示您输入密码。输入之后，用户将立即被创建。如果您不使用 <code class="language-plaintext highlighter-rouge">--username</code> 或 <code class="language-plaintext highlighter-rouge">--email</code> 选项，它会提示您输入这些值。</p><h3 id="更改密码">更改密码</h3><p>Django 不会在用户模型中存储原始（纯文本）密码，而只存储哈希值。因此，请勿尝试直接操作用户的密码属性。这就是创建用户时使用帮助函数的原因。</p><p>要更改用户的密码，您有几个选择：</p><p><code class="language-plaintext highlighter-rouge">manage.py changepassword &lt;username&gt;</code> 提供了一种从命令行更改用户密码的方法。它会提示您更改您必须输入两次的给定用户的密码。如果两者都匹配，则新密码将立即更改。如果您不提供用户，则该命令将尝试更改其用户名与当前系统用户匹配的密码。</p><p>您还可以使用 <code class="language-plaintext highlighter-rouge">set_password()</code> 以编程方式更改密码：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>&gt;&gt;&gt; from django.contrib.auth.models import User 
&gt;&gt;&gt; u = User.objects.get(username='john') 
&gt;&gt;&gt; u.set_password('new password') 
&gt;&gt;&gt; u.save()
</pre></table></code></div></div><p>如果您安装了 Django admin，您还可以在认证系统的管理页面上更改用户的密码。</p><p>Django 还提供了可用于允许用户更改自己的密码的视图和表单。</p><p>更改用户的密码将注销其所有会话。</p><h3 id="用户认证">用户认证</h3><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>authenticate(request=None, **credentials)
</pre></table></code></div></div><p>使用 <code class="language-plaintext highlighter-rouge">authenticate()</code> 来验证一组凭据。它将凭据作为关键字参数，默认情况下是 <code class="language-plaintext highlighter-rouge">username</code> 和 <code class="language-plaintext highlighter-rouge">password</code>，并针对每个验证后端进行检查，并在凭据对后端有效时返回 <code class="language-plaintext highlighter-rouge">User</code> 对象。如果凭证对任何后端无效，或者后端引发 <code class="language-plaintext highlighter-rouge">PermissionDenied</code>，则返回 <code class="language-plaintext highlighter-rouge">None</code>。例如：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>from django.contrib.auth import authenticate
user = authenticate(username='john', password='secret')
if user is not None:
    # A backend authenticated the credentials
else:
    # No backend authenticated the credentials
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">request</code> 是在身份验证后端的 <code class="language-plaintext highlighter-rouge">authenticate()</code> 方法上传递的可选 <code class="language-plaintext highlighter-rouge">HttpRequest</code>。</p><blockquote><p>这是验证一组凭据的低级别方法;例如，它由 <code class="language-plaintext highlighter-rouge">RemoteUserMiddleware</code> 使用。除非你正在编写你自己的认证系统，否则你可能不会使用它。</p></blockquote><p>后面内容如果使用 DRF 框架，基本用不到了，所以省略咯～</p><h1 id="djangocontribauth-模块">django.contrib.auth 模块</h1><h2 id="user-模型">User 模型</h2><h3 id="字段">字段</h3><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>username
</pre></table></code></div></div><p>必须。150 个字符或更少。用户名可能包含字母数字，<code class="language-plaintext highlighter-rouge">_</code>，<code class="language-plaintext highlighter-rouge">@</code>，<code class="language-plaintext highlighter-rouge">+</code>，。和 <code class="language-plaintext highlighter-rouge">-</code> 字符。如果您使用的 MySQL，请指定 <code class="language-plaintext highlighter-rouge">max_length=191</code>，因为默认情况下，MySQL 只能创建 191 个字符的唯一索引。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>first_name
</pre></table></code></div></div><p>可选 (<code class="language-plaintext highlighter-rouge">blank=True</code>)。 30 个字符或更少。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>last_name
</pre></table></code></div></div><p>可选 (<code class="language-plaintext highlighter-rouge">blank=True</code>)。 150 个字符或更少。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>email
</pre></table></code></div></div><p>可选 (<code class="language-plaintext highlighter-rouge">blank=True</code>)。邮箱地址。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>password
</pre></table></code></div></div><p>必须。密码的散列和元数据。（Django 不存储原始密码。）原始密码可以是任意长的，并且可以包含任何字符。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>groups
</pre></table></code></div></div><p>多对多关系 <code class="language-plaintext highlighter-rouge">Group</code></p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>user_permissions
</pre></table></code></div></div><p>多对多关系 <code class="language-plaintext highlighter-rouge">Permission</code></p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>is_staff
</pre></table></code></div></div><p>Bollean 类型。指定此用户是否可以访问 admin 站点。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>is_active
</pre></table></code></div></div><p>Bollean 类型。指定是否应将此用户帐户视为活动用户。我们建议您将此标志设置为 <code class="language-plaintext highlighter-rouge">False</code> 而不是删除帐户;这样，如果您的应用程序对用户有任何外键，外键不会中断。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>is_superuser
</pre></table></code></div></div><p>Bollean 类型。指定该用户具有所有权限而不明确分配它们。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>last_login
</pre></table></code></div></div><p>用户上次登录的日期时间。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>date_joined
</pre></table></code></div></div><p>指定帐户何时创建的日期时间。在创建帐户时默认设置为当前日期/时间。</p><h3 id="属性">属性</h3><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>is_authenticated
</pre></table></code></div></div><p>只读属性始终为 <code class="language-plaintext highlighter-rouge">True</code>（与 <code class="language-plaintext highlighter-rouge">AnonymousUser.is_authenticated</code> 相反，它始终为 <code class="language-plaintext highlighter-rouge">False</code>）。这是判断用户是否已通过身份验证的一种方式。这并不意味着任何权限，也不会检查用户是否处于活动状态或是否有有效的会话。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>is_anonymous
</pre></table></code></div></div><p>只读属性始终为 <code class="language-plaintext highlighter-rouge">False</code>。这是区分 <code class="language-plaintext highlighter-rouge">User</code> 和 <code class="language-plaintext highlighter-rouge">AnonymousUser</code> 对象的一种方式。通常，您应该更喜欢使用 <code class="language-plaintext highlighter-rouge">is_authenticated</code> 属性。</p><h3 id="方法">方法</h3><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>get_username()
</pre></table></code></div></div><p>返回用户的用户名。由于 <code class="language-plaintext highlighter-rouge">User</code> 模型可以被换出，您应该使用此方法而不是直接引用 <code class="language-plaintext highlighter-rouge">username</code> 属性。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>get_full_name()
</pre></table></code></div></div><p>返回 <code class="language-plaintext highlighter-rouge">first_name</code> 加上 <code class="language-plaintext highlighter-rouge">last_name</code>，之间有一个空格。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>get_short_name()
</pre></table></code></div></div><p>返回 <code class="language-plaintext highlighter-rouge">first_name</code>。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>set_password(raw_password)
</pre></table></code></div></div><p>将用户的密码设置为给定的原始字符串，注意密码散列。不保存用户对象。</p><p>当 <code class="language-plaintext highlighter-rouge">raw_password</code> 为 <code class="language-plaintext highlighter-rouge">None</code> 时，密码将被设置为不可用的密码，就像使用 <code class="language-plaintext highlighter-rouge">set_unusable_password()</code> 一样。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>check_password(raw_password)
</pre></table></code></div></div><p>如果给定的原始字符串是用户的正确密码，则返回 <code class="language-plaintext highlighter-rouge">True</code>。（在进行比较时，会将密码哈希处理。）</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>set_unusable_password()
</pre></table></code></div></div><p>标记用户没有设置密码。这与为密码输入空白字符串不同。该用户的 <code class="language-plaintext highlighter-rouge">check_password()</code> 将永远不会返回 <code class="language-plaintext highlighter-rouge">True</code>。不保存 <code class="language-plaintext highlighter-rouge">User</code> 对象。</p><p>如果您的应用程序的身份验证是针对现有的外部源（例如 LDAP 目录）进行的，您可能需要使用此功能。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>has_usable_password()
</pre></table></code></div></div><p>如果为此用户调用了 <code class="language-plaintext highlighter-rouge">set_unusable_password()</code>，则返回 <code class="language-plaintext highlighter-rouge">False</code>。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>email_user(subject, message, from_email=None, **kwargs)
</pre></table></code></div></div><p>向用户发送电子邮件。</p><h3 id="manager-方法">Manager 方法</h3><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>class models.UserManager
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">User</code> 模型有一个自定义管理器，它具有以下辅助方法（除了由 <code class="language-plaintext highlighter-rouge">BaseUserManager</code> 提供的方法外）：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>create_user(username, email=None, password=None, **extra_fields)
</pre></table></code></div></div><p>创建，保存并返回 <code class="language-plaintext highlighter-rouge">User</code>。</p><p><code class="language-plaintext highlighter-rouge">username</code> 和 <code class="language-plaintext highlighter-rouge">password</code> 设置为给定。 <code class="language-plaintext highlighter-rouge">email</code> 的域部分将自动转换为小写，并且返回的 <code class="language-plaintext highlighter-rouge">User</code> 对象将 <code class="language-plaintext highlighter-rouge">is_active</code> 设置为 <code class="language-plaintext highlighter-rouge">True</code>。</p><p>如果未提供密码，则将调用 <code class="language-plaintext highlighter-rouge">set_unusable_password()</code>。</p><p><code class="language-plaintext highlighter-rouge">extra_fields</code> 关键字参数传递给 <code class="language-plaintext highlighter-rouge">User</code> 的 <code class="language-plaintext highlighter-rouge">__init__</code> 方法，以允许在自定义用户模型上设置任意字段。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>create_superuser(username, email, password, **extra_fields)
</pre></table></code></div></div><p>与 <code class="language-plaintext highlighter-rouge">create_user()</code> 相同，但将 <code class="language-plaintext highlighter-rouge">is_staff</code> 和 <code class="language-plaintext highlighter-rouge">is_superuser</code> 设置为 <code class="language-plaintext highlighter-rouge">True</code>。</p><h2 id="实用函数">实用函数</h2><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>get_user(request)
</pre></table></code></div></div><p>返回与给定请求的会话关联的用户模型实例。</p><p>它检查存储在会话中的认证后端是否存在于 <code class="language-plaintext highlighter-rouge">AUTHENTICATION_BACKENDS</code> 中。如果存在，它使用后端的 <code class="language-plaintext highlighter-rouge">get_user()</code> 方法来检索用户模型实例，然后通过调用用户模型的 <code class="language-plaintext highlighter-rouge">get_session_auth_hash()</code> 方法来验证会话。</p><p>如果存储在会话中的认证后端不再位于 <code class="language-plaintext highlighter-rouge">AUTHENTICATION_BACKENDS</code> 中，如果用户未由后端的 <code class="language-plaintext highlighter-rouge">get_user()</code> 方法返回，或者如果会话认证哈希未验证，则返回 <code class="language-plaintext highlighter-rouge">AnonymousUser</code> 的实例。</p><h1 id="自定义-django-中的认证机制">自定义 Django 中的认证机制</h1><h2 id="其他身份认证来源">其他身份认证来源</h2><h3 id="指定身份认证后端">指定身份认证后端</h3><p>在幕后，Django 维护着一个 “身份认证后端” 列表，用于检查身份认证。当有人调用 <code class="language-plaintext highlighter-rouge">django.contrib.auth.authenticate()</code> 时，Django 尝试在所有身份验证后端进行身份验证。如果第一个验证方法失败，Django 会尝试第二个验证方法，依此类推，直到尝试完所有后端。</p><p>在 <code class="language-plaintext highlighter-rouge">AUTHENTICATION_BACKENDS</code> setting 中指定要使用的身份验证后端列表。这应该是一个 Python 路径名列表，指向知道如何进行身份验证的 Python 类。这些类可以在你的 Python 路径上的任何地方。</p><p>默认情况下，<code class="language-plaintext highlighter-rouge">AUTHENTICATION_BACKENDS</code> 被设置为：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>['django.contrib.auth.backends.ModelBackend']
</pre></table></code></div></div><p>这是检查 Django 用户数据库并查询内置权限的基本身份验证后端。它不提供通过任何速率限制机制防止暴力攻击的保护。您可以在自定义身份验证后端实现自己的速率限制机制，也可以使用大多数 Web 服务器提供的机制。</p><p><code class="language-plaintext highlighter-rouge">AUTHENTICATION_BACKENDS</code> 的顺序很重要，所以如果相同的用户名和密码在多个后端有效，Django 将在第一次正确匹配时停止处理。</p><p>如果后端引发 <code class="language-plaintext highlighter-rouge">PermissionDenied</code> 异常，认证将立即失败。 Django 不会检查后面的后端。</p><h3 id="编写身份认证后端">编写身份认证后端</h3><p>认证后端是一个实现两个必需方法的类：<code class="language-plaintext highlighter-rouge">get_user(user_id)</code> 和 <code class="language-plaintext highlighter-rouge">authenticate(request, **credentials)</code>，以及一组可选的与权限相关的授权方法。</p><p><code class="language-plaintext highlighter-rouge">get_user</code> 方法需要一个 <code class="language-plaintext highlighter-rouge">user_id</code> - 可以是一个用户名，数据库 ID 或其他，但必须是用户对象的主键，并返回一个用户对象。</p><p><code class="language-plaintext highlighter-rouge">authenticate</code> 方法将 <code class="language-plaintext highlighter-rouge">request</code> 参数和凭据作为关键字参数。大多数情况下，它看起来像这样：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>class MyBackend:
    def authenticate(self, request, username=None, password=None):
        # Check the username/password and return a user.
        ...
</pre></table></code></div></div><p>但它也可以验证 token，如下所示：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>class MyBackend:
    def authenticate(self, request, token=None):
        # Check the token and return a user.
        ...
</pre></table></code></div></div><p>无论使用哪种方式，<code class="language-plaintext highlighter-rouge">authenticate()</code> 都应该检查它获取的凭据，并在凭证有效时返回与这些凭证相匹配的用户对象。如果它们无效，则应返回 <code class="language-plaintext highlighter-rouge">None</code>。</p><p><code class="language-plaintext highlighter-rouge">request</code> 是一个 <code class="language-plaintext highlighter-rouge">HttpRequest</code>，如果没有提供给 <code class="language-plaintext highlighter-rouge">authenticate()</code>（将其传递给后端），它可能是 <code class="language-plaintext highlighter-rouge">None</code>。</p><p>Django admin 与 Django <code class="language-plaintext highlighter-rouge">User</code> 对象紧密耦合。处理这个问题的最好方法是为每个存在于后端的用户创建一个 Django <code class="language-plaintext highlighter-rouge">User</code> 对象（例如，在您的 LDAP 目录，外部 SQL 数据库等中）。您可以编写脚本来提前执行此操作，或者您的 <code class="language-plaintext highlighter-rouge">authenticate</code> 方法可以在用户第一次登录时执行。</p><p>以下是一个示例后端，它会根据 <code class="language-plaintext highlighter-rouge">settings.py</code> 文件中定义的用户名和密码变量进行身份验证，并在用户首次进行身份验证时创建一个 Django <code class="language-plaintext highlighter-rouge">User</code> 对象：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre>from django.conf import settings
from django.contrib.auth.hashers import check_password
from django.contrib.auth.models import User

class SettingsBackend:
    """
    Authenticate against the settings ADMIN_LOGIN and ADMIN_PASSWORD.

    Use the login name and a hash of the password. For example:

    ADMIN_LOGIN = 'admin'
    ADMIN_PASSWORD = 'pbkdf2_sha256$30000$Vo0VlMnkR4Bk$qEvtdyZRWTcOsCnI/oQ7fVOu1XAURIZYoOZ3iq8Dr4M='
    """

    def authenticate(self, request, username=None, password=None):
        login_valid = (settings.ADMIN_LOGIN == username)
        pwd_valid = check_password(password, settings.ADMIN_PASSWORD)
        if login_valid and pwd_valid:
            try:
                user = User.objects.get(username=username)
            except User.DoesNotExist:
                # Create a new user. There's no need to set a password
                # because only the password from settings.py is checked.
                user = User(username=username)
                user.is_staff = True
                user.is_superuser = True
                user.save()
            return user
        return None

    def get_user(self, user_id):
        try:
            return User.objects.get(pk=user_id)
        except User.DoesNotExist:
            return None
</pre></table></code></div></div><h2 id="扩展现有的-user-模型">扩展现有的 User 模型</h2><p>有两种方法可以扩展默认 <code class="language-plaintext highlighter-rouge">User</code> 模型，而不用替换自己的模型。如果您需要的更改是纯粹的行为，并且不需要对存储在数据库中的内容进行任何更改，则可以基于 <code class="language-plaintext highlighter-rouge">User</code> 创建代理模型。这允许代理模型提供的任何功能，包括默认排序，自定义管理器或自定义模型方法。</p><p>如果您希望存储与 <code class="language-plaintext highlighter-rouge">User</code> 相关的信息，则可以将 <code class="language-plaintext highlighter-rouge">OneToOneField</code> 用于包含字段的模型以获取更多信息。这种一对一模式通常称为 profile 模型，因为它可能存储有关站点用户的非 auth 相关信息。例如，您可以创建一个 <code class="language-plaintext highlighter-rouge">Employee</code> 模型：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>from django.contrib.auth.models import User

class Employee(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    department = models.CharField(max_length=100)
</pre></table></code></div></div><p>假设现有员工 Fred Smith 拥有 <code class="language-plaintext highlighter-rouge">User</code> 和 <code class="language-plaintext highlighter-rouge">Employee</code> 模型，则可以使用 Django 的标准相关模型约定访问相关信息：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>&gt;&gt;&gt; u = User.objects.get(username='fsmith') 
&gt;&gt;&gt; freds_department = u.employee.department
</pre></table></code></div></div><p>要将 profile 模型的字段添加到 admin 的用户页面，请在应用程序的 <code class="language-plaintext highlighter-rouge">admin.py</code> 中定义 <code class="language-plaintext highlighter-rouge">InlineModelAdmin</code>（对于本示例，我们将使用 <code class="language-plaintext highlighter-rouge">StackedInline</code>），并将其添加到 <code class="language-plaintext highlighter-rouge">UserAdmin</code> 类，该类用 <code class="language-plaintext highlighter-rouge">User</code> 类注册：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.contrib.auth.models import User

from my_user_profile_app.models import Employee

# Define an inline admin descriptor for Employee model
# which acts a bit like a singleton
class EmployeeInline(admin.StackedInline):
    model = Employee
    can_delete = False
    verbose_name_plural = 'employee'

# Define a new User admin
class UserAdmin(BaseUserAdmin):
    inlines = (EmployeeInline, )

# Re-register UserAdmin
admin.site.unregister(User)
admin.site.register(User, UserAdmin)
</pre></table></code></div></div><p>这些 profile 模型在任何方面都不是特别的 - 它们只是恰好与用户模型具有一对一链接的 Django 模型。因此，它们不会在创建用户时自动创建，但可以根据需要使用 <code class="language-plaintext highlighter-rouge">django.db.models.signals.post_save</code> 来创建或更新相关模型。</p><p>使用相关模型会产生额外的查询或连接来检索相关数据。根据您的需要，包含相关字段的自定义用户模型可能是您更好的选择，但是，与项目应用程序中默认用户模型的现有关系可能会证明额外的数据库负载。</p><h2 id="替换自定义-user-模型">替换自定义 <code class="language-plaintext highlighter-rouge">User</code> 模型</h2><p>某些类型的项目可能具有身份验证要求，而 Django 的内置 <code class="language-plaintext highlighter-rouge">User</code> 模型并不总是适合的。例如，在一些网站上，使用电子邮件地址作为您的身份标记而不是用户名更有意义。</p><p>Django 允许您通过为引用自定义模型的 <code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code> setting 提供值来覆盖默认用户模型：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>AUTH_USER_MODEL = 'myapp.MyUser'
</pre></table></code></div></div><p>myapp 表示 Django 应用程序的名称（它必须位于 <code class="language-plaintext highlighter-rouge">INSTALLED_APPS</code> 中），MyUser 是用作用户模型的 Django 模型的名称。</p><h3 id="启动项目时使用自定义用户模型">启动项目时使用自定义用户模型</h3><p>如果您正在开始一个新项目，强烈建议设置一个自定义用户模型，即使默认的用户模型对您来说已经足够。此模型的行为与默认用户模型的行为相同，但如果需要，您可以在将来自定义它：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>from django.contrib.auth.models import AbstractUser

class User(AbstractUser):
    pass
</pre></table></code></div></div><p>不要忘记指向 <code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code>。在创建任何迁移或首次运行 <code class="language-plaintext highlighter-rouge">manage.py migrate</code> 之前执行此操作。</p><p>另外，请在应用程序的 <code class="language-plaintext highlighter-rouge">admin.py</code> 中注册模型：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

admin.site.register(User, UserAdmin)
</pre></table></code></div></div><h3 id="引用-user-模型">引用 User 模型</h3><p>如果直接引用 <code class="language-plaintext highlighter-rouge">User</code> （例如，通过在外键中引用），那么您的代码将不适用于 <code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code> setting 已更改为不同用户模型的项目。</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>get_user_model()
</pre></table></code></div></div><p>不要直接引用 <code class="language-plaintext highlighter-rouge">User</code>，而应该使用 <code class="language-plaintext highlighter-rouge">django.contrib.auth.get_user_model()</code> 引用 <code class="language-plaintext highlighter-rouge">User</code> 模型。此方法将返回当前活动的用户模型 - 如果指定了用户模型，则返回自定义用户模型，否则返回 <code class="language-plaintext highlighter-rouge">User</code>。</p><p>在为用户模型定义外键或多对多关系时，应使用 <code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code> setting 指定自定义模型。例如：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>from django.conf import settings
from django.db import models

class Article(models.Model):
    author = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
    )
</pre></table></code></div></div><p>连接到用户模型发送的信号时，应使用 <code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code> setting 指定自定义模型。例如：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>from django.conf import settings
from django.db.models.signals import post_save

def post_save_receiver(sender, instance, created, **kwargs):
    pass

post_save.connect(post_save_receiver, sender=settings.AUTH_USER_MODEL)
</pre></table></code></div></div><p>一般来说，用导入时执行的代码中的 <code class="language-plaintext highlighter-rouge">AUTH_USER_MODEL</code> setting 来引用用户模型是最容易的，但是，也可以在 Django 导入模型时调用 <code class="language-plaintext highlighter-rouge">get_user_model()</code>，以便使用 <code class="language-plaintext highlighter-rouge">models.ForeignKey(get_user_model(), ...)</code>。</p><p>如果您的应用使用多个用户模型进行测试，例如使用 <code class="language-plaintext highlighter-rouge">@override_settings(AUTH_USER_MODEL=...)</code>，并且将 <code class="language-plaintext highlighter-rouge">get_user_model()</code> 的结果缓存在模块级变量中，则可能需要侦听 <code class="language-plaintext highlighter-rouge">setting_changed</code> 信号以清除缓存。例如：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>from django.apps import apps
from django.contrib.auth import get_user_model
from django.core.signals import setting_changed
from django.dispatch import receiver

@receiver(setting_changed)
def user_model_swapped(**kwargs):
    if kwargs['setting'] == 'AUTH_USER_MODEL':
        apps.clear_cache()
        from myapp import some_module
        some_module.UserModel = get_user_model()
</pre></table></code></div></div><p>来源：https://www.django.cn/article/show-18.html</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/django/'>Django</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/django/" class="post-tag no-text-decoration" >Django</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Django身份认证系统 - 图样图森破&url=https://justzxy.cn/posts/django-auth/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Django身份认证系统 - 图样图森破&u=https://justzxy.cn/posts/django-auth/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Django身份认证系统 - 图样图森破&url=https://justzxy.cn/posts/django-auth/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/js/">JavaScript基础整理</a><li><a href="/posts/http-code/">HTTP 响应码</a><li><a href="/posts/pip/">python包管理工具pip</a><li><a href="/posts/pyecharts-pie/">pyecharts饼图使用笔记</a><li><a href="/posts/redis-fast/">Redis为什么这么快</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python%E6%A0%87%E5%87%86%E5%BA%93/">Python标准库</a> <a class="post-tag" href="/tags/web%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF/">Web开发技术</a> <a class="post-tag" href="/tags/python%E8%BF%9B%E9%98%B6/">Python进阶</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a> <a class="post-tag" href="/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">环境配置</a> <a class="post-tag" href="/tags/django/">Django</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python%E5%9F%BA%E7%A1%80/">Python基础</a> <a class="post-tag" href="/tags/redis/">Redis</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/wsgi/"><div class="card-body"> <span class="timeago small" > Nov 9, 2020 <i class="unloaded">2020-11-09T22:24:55+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WSGI & uwsgi</h3><div class="text-muted small"><p> WSGI协议 首先弄清下面几个概念： WSGI：全称是Web Server Gateway Interface，WSGI不是服务器，python模块，框架，API或者任何软件，只是一种规范，描述web server如何与web application通信的规范。server和application的规范在PEP 3333中有具体描述。要实现WSGI协议，必须同时实现web server和...</p></div></div></a></div><div class="card"> <a href="/posts/django-note/"><div class="card-body"> <span class="timeago small" > Jan 6, 2019 <i class="unloaded">2019-01-06T19:14:46+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Django基础</h3><div class="text-muted small"><p> Web框架的意义 用于搭建web应用程序 免去不同 Web 应用相同代码部分的重复编写，只需关心 Web 应用核心的业务逻辑实现 Web应用程序的本质 接收并解析 HTTP 请求 ，获取具体的请求信息 处理本次 HTTP 请求 ，即完成本次请求的业务逻辑处理 构造并返回处理结果 —— HTTP 响应 1.Django介绍 Django 是一款重量级...</p></div></div></a></div><div class="card"> <a href="/posts/django-cmd/"><div class="card-body"> <span class="timeago small" > Jun 6, 2019 <i class="unloaded">2019-06-06T19:57:32+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Django常用命令介绍</h3><div class="text-muted small"><p> 在DJango里django-admin.py和manage.py都是Django的命令工具集，用于处理系统管理相关操作，而manage.py是在创建Django工程时自动生成的，manage.py是对django-admin.py的简单包装，二者的作用基本一致。 区别： 1、django-admin存放在Python的site-packages\django\bin 里，manage....</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/django-orm/" class="btn btn-outline-primary" prompt="Older"><p>Django-ORM常用操作</p></a> <a href="/posts/django-bushu/" class="btn btn-outline-primary" prompt="Newer"><p>CentOS7下部署Django</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 tooYoungtooSimple. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python%E6%A0%87%E5%87%86%E5%BA%93/">Python标准库</a> <a class="post-tag" href="/tags/web%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF/">Web开发技术</a> <a class="post-tag" href="/tags/python%E8%BF%9B%E9%98%B6/">Python进阶</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a> <a class="post-tag" href="/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">环境配置</a> <a class="post-tag" href="/tags/django/">Django</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/python%E5%9F%BA%E7%A1%80/">Python基础</a> <a class="post-tag" href="/tags/redis/">Redis</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://justzxy.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script>
