---
title: MySQL基础-主从同步与读写分离
date: 2018-03-30 21:38:43 +0800
categories: [数据库]
tags: [数据库]
---
## 复制集与分布式

- 复制集（Replication）
    - 数据库中数据相同，起到备份作用
    - 高可用 High Available HA
- 分布式（Distribution）
    - 数据库中数据不同，共同组成完整的数据集合
    - 通常每个节点被称为一个分片（shard)
    - 高吞吐 High Throughput
- 复制集与分布式可以单独使用，也可以组合使用（即每个分片都组建一个复制集）
- 关于主（Master）从（Slave）
    - 这个概念是从使用的角度来阐述问题的
    - 主节点 -> 表示程序在这个节点上最先更新数据
    - 从节点 -> 表示这个节点的数据是要通过复制主节点而来
    - 复制集 可选 主从、主主、主主从从
    - 分布式 每个分片都是主，组合使用复制集的时候，复制集的是从

## 主从同步机制

### **1.主从同步介绍和优点**

主从同步使得数据可以从一个数据库服务器复制到其他服务器上，在复制数据时，一个服务器充当主服务器（master），其余的服务器充当从服务器（slave）。因为复制是异步进行的，所以从服务器不需要一直连接着主服务器，从服务器甚至可以通过拨号断断续续地连接主服务器。通过配置文件，可以指定复制所有的数据库，某个数据库，甚至是某个数据库上的某个表。

- 在多台数据服务器中，分为主服务器和从服务器。一台主服务器对应多台从服务器。
- 主服务器只负责写入数据，从服务器只负责同步主服务器的数据，并让外部程序读取数据。
- 主服务器写入数据后，即刻将写入数据的命令发送给从服务器，从而使得主从数据同步。
- 应用程序可以随机读取某一台从服务器的数据，这样就可以分摊读取数据的压力。
- 当从服务器不能工作时，整个系统将不受影响；当主服务器不能工作时，可以方便地从从服务器选举一台来当主服务器
- 使用主从同步的优点：
    - 提高读写性能
        - 因为主从同步之后，数据写入和读取是在不同的服务器上进行的，而且可以通过增加从服务器来提高数据库的读取性能。
    - 提高数据安全
        - 因为数据已复制到从服务器，可以在从服务器上备份而不破坏主服务器相应数据。

### **2.主从同步机制**

首先，master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events）；

然后，slave将master的binary log events拷贝到它的中继日志(relay log)；

最后，slave重做中继日志中的事件，将改变反映它自己的数据。

![](/refer/MySQL主从同步原理.png)

该过程的第一部分就是master记录二进制日志。在每个事务更新数据完成之前，master在二日志记录这些改变。MySQL将事务串行的写入二进制日志，即使事务中的语句都是交叉执行的。在事件写入二进制日志完成后，master通知存储引擎提交事务。

下一步就是slave将master的binary log拷贝到它自己的中继日志。首先，slave开始一个工作线程——I/O线程。I/O线程在master上打开一个普通的连接，然后开始binlog dump process。Binlog dump process从master的二进制日志中读取事件，如果已经跟上master，它会睡眠并等待master产生新的事件。I/O线程将这些事件写入中继日志。

SQL slave thread处理该过程的最后一步。SQL线程从中继日志读取事件，更新slave的数据，使其与master中的数据一致。只要该线程与I/O线程保持一致，中继日志通常会位于OS的缓存中，所以中继日志的开销很小。

此外，在master中也有一个工作线程：和其它MySQL的连接一样，slave在master中打开一个连接也会使得master开始一个线程。

**利用主从在达到高可用的同时，也可以通过读写分离提供吞吐量。**

## 配置主从同步的基本步骤

1. 在主服务器上，必须开启二进制日志机制和配置一个独立的ID
2. 在每一个从服务器上，配置一个唯一的ID，创建一个用来专门复制主服务器数据的账号
3. 在开始复制进程前，在主服务器上记录二进制文件的位置信息
4. 如果在开始复制之前，数据库中已经有数据，就必须先创建一个数据快照（可以使用mysqldump导出数据库，或者直接复制数据文件）
5. 配置从服务器要连接的主服务器的IP地址和登陆授权，二进制日志文件名和位置